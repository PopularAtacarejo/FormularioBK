<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Análise de Candidaturas - Sistema RH</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --light-bg: #f8f9fa;
            --card-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }
        
        body {
            background-color: #f5f7fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #333;
        }
        
        .navbar-brand {
            font-weight: 700;
            color: var(--primary-color);
        }
        
        .card {
            border: none;
            border-radius: 10px;
            box-shadow: var(--card-shadow);
            transition: var(--transition);
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }
        
        .candidatura-item {
            border-left: 4px solid var(--secondary-color);
            padding-left: 15px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .candidatura-item:hover {
            background-color: rgba(52, 152, 219, 0.05);
            transform: translateX(5px);
        }
        
        .status-badge {
            font-size: 0.75rem;
            padding: 4px 8px;
            border-radius: 20px;
        }
        
        .filter-section {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: var(--card-shadow);
        }
        
        .modal-content {
            border-radius: 10px;
            border: none;
        }
        
        .modal-header {
            background-color: var(--primary-color);
            color: white;
            border-radius: 10px 10px 0 0;
        }
        
        .btn-primary {
            background-color: var(--secondary-color);
            border-color: var(--secondary-color);
        }
        
        .btn-primary:hover {
            background-color: #2980b9;
            border-color: #2980b9;
        }
        
        .btn-outline-primary {
            color: var(--secondary-color);
            border-color: var(--secondary-color);
        }
        
        .btn-outline-primary:hover {
            background-color: var(--secondary-color);
            border-color: var(--secondary-color);
        }
        
        .stats-card {
            text-align: center;
            padding: 15px;
        }
        
        .stats-number {
            font-size: 2rem;
            font-weight: bold;
            color: var(--secondary-color);
        }
        
        .stats-label {
            font-size: 0.9rem;
            color: #6c757d;
        }
        
        .pagination .page-link {
            color: var(--secondary-color);
        }
        
        .pagination .page-item.active .page-link {
            background-color: var(--secondary-color);
            border-color: var(--secondary-color);
        }
        
        .table th {
            background-color: var(--primary-color);
            color: white;
        }
        
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
        }
        
        .spinner-border {
            color: var(--secondary-color);
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="bi bi-person-badge me-2"></i>Sistema RH - Análise de Candidaturas
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="bi bi-person-circle me-1"></i> <span id="userName">Usuário</span>
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" id="changePasswordBtn"><i class="bi bi-key me-2"></i>Alterar Senha</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item text-danger" href="#" onclick="logout()"><i class="bi bi-box-arrow-right me-2"></i>Sair</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container-fluid mt-4">
        <div class="row">
            <!-- Sidebar Filters -->
            <div class="col-lg-3 mb-4">
                <div class="filter-section">
                    <h5 class="mb-3"><i class="bi bi-funnel me-2"></i>Filtros</h5>
                    
                    <!-- Filtro de Pesquisa -->
                    <div class="mb-3">
                        <label for="searchInput" class="form-label">Pesquisar</label>
                        <input type="text" class="form-control" id="searchInput" placeholder="Nome, CPF, Email...">
                    </div>
                    
                    <!-- Filtro de Cidade -->
                    <div class="mb-3">
                        <label for="cityFilter" class="form-label">Cidade</label>
                        <select class="form-select" id="cityFilter">
                            <option value="">Todas as cidades</option>
                        </select>
                    </div>
                    
                    <!-- Filtro de Bairro -->
                    <div class="mb-3">
                        <label for="neighborhoodFilter" class="form-label">Bairro</label>
                        <select class="form-select" id="neighborhoodFilter">
                            <option value="">Todos os bairros</option>
                        </select>
                    </div>
                    
                    <!-- Filtro de Transporte -->
                    <div class="mb-3">
                        <label for="transportFilter" class="form-label">Transporte</label>
                        <select class="form-select" id="transportFilter">
                            <option value="">Todos</option>
                            <option value="Sim">Tem transporte</option>
                            <option value="Não">Não tem transporte</option>
                        </select>
                    </div>
                    
                    <!-- Filtro de Vaga -->
                    <div class="mb-3">
                        <label for="jobFilter" class="form-label">Vaga</label>
                        <select class="form-select" id="jobFilter">
                            <option value="">Todas as vagas</option>
                        </select>
                    </div>
                    
                    <!-- Filtro de Status -->
                    <div class="mb-3">
                        <label for="statusFilter" class="form-label">Status</label>
                        <select class="form-select" id="statusFilter">
                            <option value="">Todos os status</option>
                        </select>
                    </div>
                    
                    <!-- Filtro de Data -->
                    <div class="mb-3">
                        <label for="dateFromFilter" class="form-label">Data de</label>
                        <input type="date" class="form-control" id="dateFromFilter">
                    </div>
                    
                    <div class="mb-3">
                        <label for="dateToFilter" class="form-label">Data até</label>
                        <input type="date" class="form-control" id="dateToFilter">
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button class="btn btn-primary" id="applyFiltersBtn">
                            <i class="bi bi-check-lg me-1"></i>Aplicar Filtros
                        </button>
                        <button class="btn btn-outline-secondary" id="clearFiltersBtn">
                            <i class="bi bi-x-lg me-1"></i>Limpar Filtros
                        </button>
                    </div>
                </div>
                
                <!-- Stats Cards -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card stats-card">
                            <div class="stats-number" id="totalCandidaturas">0</div>
                            <div class="stats-label">Total de Candidaturas</div>
                        </div>
                    </div>
                    <div class="col-12 mt-3">
                        <div class="card stats-card">
                            <div class="stats-number" id="novasCandidaturas">0</div>
                            <div class="stats-label">Novas Candidaturas</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Main Content -->
            <div class="col-lg-9">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-people me-2"></i>Candidaturas</h5>
                        <div>
                            <span class="badge bg-primary" id="filteredCount">0</span>
                            <span class="ms-2">de</span>
                            <span class="badge bg-secondary ms-1" id="totalCount">0</span>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Loading Indicator -->
                        <div class="loading d-none" id="loadingIndicator">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Carregando...</span>
                            </div>
                        </div>
                        
                        <!-- Candidaturas Table -->
                        <div class="table-responsive" id="candidaturasTableContainer">
                            <table class="table table-hover" id="candidaturasTable">
                                <thead>
                                    <tr>
                                        <th>Nome</th>
                                        <th>CPF</th>
                                        <th>Cidade</th>
                                        <th>Bairro</th>
                                        <th>Transporte</th>
                                        <th>Vaga</th>
                                        <th>Status</th>
                                        <th>Data</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="candidaturasTableBody">
                                    <!-- Candidaturas serão carregadas aqui via JavaScript -->
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Pagination -->
                        <nav aria-label="Navegação de páginas" class="mt-4">
                            <ul class="pagination justify-content-center" id="paginationContainer">
                                <!-- Paginação será gerada via JavaScript -->
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Detalhes da Candidatura -->
    <div class="modal fade" id="candidaturaModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="candidaturaModalLabel">Detalhes da Candidatura</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Informações Pessoais</h6>
                            <p><strong>Nome:</strong> <span id="modalNome"></span></p>
                            <p><strong>CPF:</strong> <span id="modalCpf"></span></p>
                            <p><strong>Email:</strong> <span id="modalEmail"></span></p>
                            <p><strong>Telefone:</strong> <span id="modalTelefone"></span></p>
                        </div>
                        <div class="col-md-6">
                            <h6>Endereço</h6>
                            <p><strong>CEP:</strong> <span id="modalCep"></span></p>
                            <p><strong>Cidade:</strong> <span id="modalCidade"></span></p>
                            <p><strong>Bairro:</strong> <span id="modalBairro"></span></p>
                            <p><strong>Rua:</strong> <span id="modalRua"></span></p>
                        </div>
                    </div>
                    
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <h6>Informações da Vaga</h6>
                            <p><strong>Vaga:</strong> <span id="modalVaga"></span></p>
                            <p><strong>Transporte:</strong> <span id="modalTransporte"></span></p>
                            <p><strong>Data de Envio:</strong> <span id="modalData"></span></p>
                        </div>
                        <div class="col-md-6">
                            <h6>Status</h6>
                            <div class="mb-3">
                                <label for="statusSelect" class="form-label">Alterar Status</label>
                                <select class="form-select" id="statusSelect">
                                    <!-- Opções de status serão carregadas via JavaScript -->
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="observacaoInput" class="form-label">Observação</label>
                                <textarea class="form-control" id="observacaoInput" rows="3" placeholder="Adicione uma observação sobre esta candidatura..."></textarea>
                            </div>
                            <button class="btn btn-primary w-100" id="updateStatusBtn">
                                <i class="bi bi-check-lg me-1"></i>Atualizar Status
                            </button>
                        </div>
                    </div>
                    
                    <div class="row mt-4">
                        <div class="col-12">
                            <h6>Currículo</h6>
                            <div class="d-flex justify-content-between align-items-center">
                                <span id="curriculoNome">curriculo.pdf</span>
                                <button class="btn btn-outline-primary" id="downloadCurriculoBtn">
                                    <i class="bi bi-download me-1"></i>Baixar Currículo
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mt-4">
                        <div class="col-12">
                            <h6>Histórico de Comentários</h6>
                            <div id="comentariosContainer">
                                <!-- Comentários serão carregados aqui -->
                            </div>
                            
                            <div class="mt-3">
                                <div class="mb-3">
                                    <label for="novoComentarioInput" class="form-label">Adicionar Comentário</label>
                                    <textarea class="form-control" id="novoComentarioInput" rows="3" placeholder="Digite seu comentário..."></textarea>
                                </div>
                                <button class="btn btn-primary" id="addComentarioBtn">
                                    <i class="bi bi-plus-circle me-1"></i>Adicionar Comentário
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Alteração de Senha -->
    <div class="modal fade" id="changePasswordModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Alterar Senha</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="currentPassword" class="form-label">Senha Atual</label>
                        <input type="password" class="form-control" id="currentPassword">
                    </div>
                    <div class="mb-3">
                        <label for="newPassword" class="form-label">Nova Senha</label>
                        <input type="password" class="form-control" id="newPassword">
                    </div>
                    <div class="mb-3">
                        <label for="confirmPassword" class="form-label">Confirmar Nova Senha</label>
                        <input type="password" class="form-control" id="confirmPassword">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="savePasswordBtn">Salvar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Variáveis globais
        let currentUser = null;
        let candidaturas = [];
        let filteredCandidaturas = [];
        let currentPage = 1;
        const itemsPerPage = 10;
        let currentCandidaturaId = null;

        // Inicialização
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
            loadFilters();
            loadCandidaturas();
            setupEventListeners();
        });

        // Verificar autenticação
        function checkAuth() {
            if (!authManager.isAuthenticated()) {
                authManager.redirectToLogin();
                return;
            }
            
            currentUser = authManager.getCurrentUser();
            document.getElementById('userName').textContent = currentUser.nome || currentUser.email;
        }

        // Carregar opções de filtro
        function loadFilters() {
            // Carregar status disponíveis
            fetch('/api/users/status', {
                headers: {
                    'Authorization': `Bearer ${getToken()}`
                }
            })
            .then(response => response.json())
            .then(data => {
                const statusSelect = document.getElementById('statusFilter');
                const modalStatusSelect = document.getElementById('statusSelect');
                
                data.status.forEach(status => {
                    const option = document.createElement('option');
                    option.value = status;
                    option.textContent = status;
                    
                    statusSelect.appendChild(option.cloneNode(true));
                    modalStatusSelect.appendChild(option);
                });
            })
            .catch(error => {
                console.error('Erro ao carregar status:', error);
            });
            
            // Carregar vagas disponíveis
            fetch('/api/vagas')
            .then(response => response.json())
            .then(data => {
                const jobFilter = document.getElementById('jobFilter');
                
                data.forEach(vaga => {
                    const option = document.createElement('option');
                    option.value = vaga.nome;
                    option.textContent = vaga.nome;
                    jobFilter.appendChild(option);
                });
            })
            .catch(error => {
                console.error('Erro ao carregar vagas:', error);
            });
        }

        // Carregar candidaturas
        function loadCandidaturas() {
            showLoading(true);
            
            const token = getToken();
            fetch('/api/users/candidaturas', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(response => response.json())
            .then(data => {
                candidaturas = data.candidaturas || [];
                updateCandidaturasDisplay();
                updateStats();
                updateFilterOptions();
                showLoading(false);
            })
            .catch(error => {
                console.error('Erro ao carregar candidaturas:', error);
                showLoading(false);
            });
        }

        // Atualizar exibição das candidaturas
        function updateCandidaturasDisplay() {
            const tableBody = document.getElementById('candidaturasTableBody');
            tableBody.innerHTML = '';
            
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, filteredCandidaturas.length);
            
            for (let i = startIndex; i < endIndex; i++) {
                const candidatura = filteredCandidaturas[i];
                const row = document.createElement('tr');
                row.className = 'candidatura-item';
                row.setAttribute('data-id', candidatura.id);
                
                // Formatar data
                const dataEnvio = new Date(candidatura.enviado_em);
                const dataFormatada = dataEnvio.toLocaleDateString('pt-BR');
                
                // Determinar classe do badge de status
                let statusClass = 'bg-secondary';
                if (candidatura.status === 'Novo') statusClass = 'bg-primary';
                if (candidatura.status === 'Selecionado') statusClass = 'bg-success';
                if (candidatura.status === 'Contratado') statusClass = 'bg-success';
                if (candidatura.status === 'Não Atendeu a Ligação') statusClass = 'bg-warning';
                if (candidatura.status === 'Desistiu') statusClass = 'bg-danger';
                if (candidatura.status === 'Já trabalhou Aqui') statusClass = 'bg-info';
                
                row.innerHTML = `
                    <td>${candidatura.nome}</td>
                    <td>${formatCPF(candidatura.cpf)}</td>
                    <td>${candidatura.cidade}</td>
                    <td>${candidatura.bairro}</td>
                    <td>${candidatura.transporte}</td>
                    <td>${candidatura.vaga}</td>
                    <td><span class="badge ${statusClass} status-badge">${candidatura.status}</span></td>
                    <td>${dataFormatada}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary view-candidatura" data-id="${candidatura.id}">
                            <i class="bi bi-eye"></i>
                        </button>
                    </td>
                `;
                
                tableBody.appendChild(row);
            }
            
            updatePagination();
            document.getElementById('filteredCount').textContent = filteredCandidaturas.length;
            document.getElementById('totalCount').textContent = candidaturas.length;
        }

        // Atualizar paginação
        function updatePagination() {
            const totalPages = Math.ceil(filteredCandidaturas.length / itemsPerPage);
            const paginationContainer = document.getElementById('paginationContainer');
            paginationContainer.innerHTML = '';
            
            if (totalPages <= 1) return;
            
            // Botão anterior
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
            prevLi.innerHTML = `<a class="page-link" href="#" data-page="${currentPage - 1}">Anterior</a>`;
            paginationContainer.appendChild(prevLi);
            
            // Páginas
            for (let i = 1; i <= totalPages; i++) {
                const pageLi = document.createElement('li');
                pageLi.className = `page-item ${currentPage === i ? 'active' : ''}`;
                pageLi.innerHTML = `<a class="page-link" href="#" data-page="${i}">${i}</a>`;
                paginationContainer.appendChild(pageLi);
            }
            
            // Botão próximo
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
            nextLi.innerHTML = `<a class="page-link" href="#" data-page="${currentPage + 1}">Próximo</a>`;
            paginationContainer.appendChild(nextLi);
        }

        // Atualizar estatísticas
        function updateStats() {
            const totalCandidaturas = candidaturas.length;
            const novasCandidaturas = candidaturas.filter(c => c.status === 'Novo').length;
            
            document.getElementById('totalCandidaturas').textContent = totalCandidaturas;
            document.getElementById('novasCandidaturas').textContent = novasCandidaturas;
        }

        // Atualizar opções de filtro com base nos dados
        function updateFilterOptions() {
            // Cidades únicas
            const cidades = [...new Set(candidaturas.map(c => c.cidade).filter(Boolean))];
            const cityFilter = document.getElementById('cityFilter');
            
            // Limpar opções existentes (exceto a primeira)
            while (cityFilter.children.length > 1) {
                cityFilter.removeChild(cityFilter.lastChild);
            }
            
            cidades.sort().forEach(cidade => {
                const option = document.createElement('option');
                option.value = cidade;
                option.textContent = cidade;
                cityFilter.appendChild(option);
            });
            
            // Bairros únicos
            const bairros = [...new Set(candidaturas.map(c => c.bairro).filter(Boolean))];
            const neighborhoodFilter = document.getElementById('neighborhoodFilter');
            
            // Limpar opções existentes (exceto a primeira)
            while (neighborhoodFilter.children.length > 1) {
                neighborhoodFilter.removeChild(neighborhoodFilter.lastChild);
            }
            
            bairros.sort().forEach(bairro => {
                const option = document.createElement('option');
                option.value = bairro;
                option.textContent = bairro;
                neighborhoodFilter.appendChild(option);
            });
        }

        // Aplicar filtros
        function applyFilters() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const cityFilter = document.getElementById('cityFilter').value;
            const neighborhoodFilter = document.getElementById('neighborhoodFilter').value;
            const transportFilter = document.getElementById('transportFilter').value;
            const jobFilter = document.getElementById('jobFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            const dateFrom = document.getElementById('dateFromFilter').value;
            const dateTo = document.getElementById('dateToFilter').value;
            
            filteredCandidaturas = candidaturas.filter(candidatura => {
                // Filtro de pesquisa
                if (searchTerm && 
                    !candidatura.nome.toLowerCase().includes(searchTerm) && 
                    !candidatura.cpf.includes(searchTerm) &&
                    !candidatura.email.toLowerCase().includes(searchTerm)) {
                    return false;
                }
                
                // Filtro de cidade
                if (cityFilter && candidatura.cidade !== cityFilter) {
                    return false;
                }
                
                // Filtro de bairro
                if (neighborhoodFilter && candidatura.bairro !== neighborhoodFilter) {
                    return false;
                }
                
                // Filtro de transporte
                if (transportFilter && candidatura.transporte !== transportFilter) {
                    return false;
                }
                
                // Filtro de vaga
                if (jobFilter && candidatura.vaga !== jobFilter) {
                    return false;
                }
                
                // Filtro de status
                if (statusFilter && candidatura.status !== statusFilter) {
                    return false;
                }
                
                // Filtro de data
                if (dateFrom) {
                    const dataEnvio = new Date(candidatura.enviado_em);
                    const dataFrom = new Date(dateFrom);
                    if (dataEnvio < dataFrom) return false;
                }
                
                if (dateTo) {
                    const dataEnvio = new Date(candidatura.enviado_em);
                    const dataTo = new Date(dateTo);
                    dataTo.setHours(23, 59, 59, 999); // Fim do dia
                    if (dataEnvio > dataTo) return false;
                }
                
                return true;
            });
            
            currentPage = 1;
            updateCandidaturasDisplay();
        }

        // Limpar filtros
        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('cityFilter').value = '';
            document.getElementById('neighborhoodFilter').value = '';
            document.getElementById('transportFilter').value = '';
            document.getElementById('jobFilter').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('dateFromFilter').value = '';
            document.getElementById('dateToFilter').value = '';
            
            filteredCandidaturas = [...candidaturas];
            currentPage = 1;
            updateCandidaturasDisplay();
        }

        // Mostrar/ocultar loading
        function showLoading(show) {
            const loadingIndicator = document.getElementById('loadingIndicator');
            const tableContainer = document.getElementById('candidaturasTableContainer');
            
            if (show) {
                loadingIndicator.classList.remove('d-none');
                tableContainer.classList.add('d-none');
            } else {
                loadingIndicator.classList.add('d-none');
                tableContainer.classList.remove('d-none');
            }
        }

        // Abrir modal de detalhes da candidatura
        function openCandidaturaModal(candidaturaId) {
            currentCandidaturaId = candidaturaId;
            const candidatura = candidaturas.find(c => c.id === candidaturaId);
            
            if (!candidatura) return;
            
            // Preencher informações no modal
            document.getElementById('modalNome').textContent = candidatura.nome;
            document.getElementById('modalCpf').textContent = formatCPF(candidatura.cpf);
            document.getElementById('modalEmail').textContent = candidatura.email;
            document.getElementById('modalTelefone').textContent = candidatura.telefone;
            document.getElementById('modalCep').textContent = candidatura.cep;
            document.getElementById('modalCidade').textContent = candidatura.cidade;
            document.getElementById('modalBairro').textContent = candidatura.bairro;
            document.getElementById('modalRua').textContent = candidatura.rua;
            document.getElementById('modalVaga').textContent = candidatura.vaga;
            document.getElementById('modalTransporte').textContent = candidatura.transporte;
            
            const dataEnvio = new Date(candidatura.enviado_em);
            document.getElementById('modalData').textContent = dataEnvio.toLocaleDateString('pt-BR') + ' ' + dataEnvio.toLocaleTimeString('pt-BR');
            
            // Definir status atual
            document.getElementById('statusSelect').value = candidatura.status;
            
            // Carregar comentários
            loadComentarios(candidaturaId);
            
            // Configurar botão de download
            document.getElementById('downloadCurriculoBtn').onclick = function() {
                downloadCurriculo(candidatura.arquivo_url, candidatura.nome);
            };
            
            // Mostrar modal
            const modal = new bootstrap.Modal(document.getElementById('candidaturaModal'));
            modal.show();
        }

        // Carregar comentários da candidatura
        function loadComentarios(candidaturaId) {
            const comentariosContainer = document.getElementById('comentariosContainer');
            comentariosContainer.innerHTML = '<p>Carregando comentários...</p>';
            
            fetch(`/api/users/comentarios/${candidaturaId}`, {
                headers: {
                    'Authorization': `Bearer ${getToken()}`
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.length === 0) {
                    comentariosContainer.innerHTML = '<p class="text-muted">Nenhum comentário ainda.</p>';
                    return;
                }
                
                let comentariosHTML = '';
                data.forEach(comentario => {
                    const dataComentario = new Date(comentario.criado_em);
                    const dataFormatada = dataComentario.toLocaleDateString('pt-BR') + ' ' + dataComentario.toLocaleTimeString('pt-BR');
                    
                    comentariosHTML += `
                        <div class="card mb-2">
                            <div class="card-body p-3">
                                <div class="d-flex justify-content-between">
                                    <h6 class="card-title mb-1">${comentario.usuario.nome}</h6>
                                    <small class="text-muted">${dataFormatada}</small>
                                </div>
                                <p class="card-text mb-0">${comentario.comentario}</p>
                            </div>
                        </div>
                    `;
                });
                
                comentariosContainer.innerHTML = comentariosHTML;
            })
            .catch(error => {
                console.error('Erro ao carregar comentários:', error);
                comentariosContainer.innerHTML = '<p class="text-danger">Erro ao carregar comentários.</p>';
            });
        }

        // Adicionar comentário
        function addComentario() {
            const comentarioText = document.getElementById('novoComentarioInput').value.trim();
            
            if (!comentarioText) {
                alert('Por favor, digite um comentário.');
                return;
            }
            
            fetch('/api/users/comentarios', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${getToken()}`
                },
                body: JSON.stringify({
                    candidatura_id: currentCandidaturaId,
                    comentario: comentarioText,
                    tipo: 'observacao'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.id) {
                    document.getElementById('novoComentarioInput').value = '';
                    loadComentarios(currentCandidaturaId);
                } else {
                    alert('Erro ao adicionar comentário.');
                }
            })
            .catch(error => {
                console.error('Erro ao adicionar comentário:', error);
                alert('Erro ao adicionar comentário.');
            });
        }

        // Atualizar status da candidatura
        function updateStatus() {
            const novoStatus = document.getElementById('statusSelect').value;
            const observacao = document.getElementById('observacaoInput').value.trim();
            
            if (!novoStatus) {
                alert('Por favor, selecione um status.');
                return;
            }
            
            fetch(`/api/users/candidaturas/${currentCandidaturaId}/status`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${getToken()}`
                },
                body: JSON.stringify({
                    status: novoStatus,
                    observacao: observacao || null
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.ok) {
                    alert('Status atualizado com sucesso!');
                    
                    // Atualizar a candidatura na lista
                    const candidaturaIndex = candidaturas.findIndex(c => c.id === currentCandidaturaId);
                    if (candidaturaIndex !== -1) {
                        candidaturas[candidaturaIndex].status = novoStatus;
                        candidaturas[candidaturaIndex].status_alterado_em = new Date().toISOString();
                        candidaturas[candidaturaIndex].status_alterado_por = currentUser.id;
                    }
                    
                    // Atualizar exibição
                    updateCandidaturasDisplay();
                    
                    // Fechar modal se desejar
                    // bootstrap.Modal.getInstance(document.getElementById('candidaturaModal')).hide();
                } else {
                    alert('Erro ao atualizar status.');
                }
            })
            .catch(error => {
                console.error('Erro ao atualizar status:', error);
                alert('Erro ao atualizar status.');
            });
        }

        // Baixar currículo
        function downloadCurriculo(url, nome) {
            if (!url) {
                alert('URL do currículo não disponível.');
                return;
            }
            
            // Criar link temporário para download
            const link = document.createElement('a');
            link.href = url;
            link.download = `curriculo_${nome.replace(/\s+/g, '_')}.pdf`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Alterar senha
        function changePassword() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (!currentPassword || !newPassword || !confirmPassword) {
                alert('Por favor, preencha todos os campos.');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                alert('As senhas não coincidem.');
                return;
            }
            
            if (newPassword.length < 6) {
                alert('A nova senha deve ter pelo menos 6 caracteres.');
                return;
            }
            
            fetch('/api/users/change-password', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${getToken()}`
                },
                body: JSON.stringify({
                    currentPassword: currentPassword,
                    newPassword: newPassword
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.ok) {
                    alert('Senha alterada com sucesso!');
                    bootstrap.Modal.getInstance(document.getElementById('changePasswordModal')).hide();
                    
                    // Limpar campos
                    document.getElementById('currentPassword').value = '';
                    document.getElementById('newPassword').value = '';
                    document.getElementById('confirmPassword').value = '';
                } else {
                    alert(data.message || 'Erro ao alterar senha.');
                }
            })
            .catch(error => {
                console.error('Erro ao alterar senha:', error);
                alert('Erro ao alterar senha.');
            });
        }

        // Configurar event listeners
        function setupEventListeners() {
            // Filtros
            document.getElementById('applyFiltersBtn').addEventListener('click', applyFilters);
            document.getElementById('clearFiltersBtn').addEventListener('click', clearFilters);
            
            // Paginação
            document.getElementById('paginationContainer').addEventListener('click', function(e) {
                e.preventDefault();
                if (e.target.tagName === 'A' && e.target.dataset.page) {
                    currentPage = parseInt(e.target.dataset.page);
                    updateCandidaturasDisplay();
                }
            });
            
            // Modal de candidatura
            document.getElementById('candidaturasTableBody').addEventListener('click', function(e) {
                if (e.target.closest('.view-candidatura')) {
                    const candidaturaId = e.target.closest('.view-candidatura').dataset.id;
                    openCandidaturaModal(candidaturaId);
                }
            });
            
            // Botões do modal
            document.getElementById('updateStatusBtn').addEventListener('click', updateStatus);
            document.getElementById('addComentarioBtn').addEventListener('click', addComentario);
            
            // Alteração de senha
            document.getElementById('changePasswordBtn').addEventListener('click', function() {
                const modal = new bootstrap.Modal(document.getElementById('changePasswordModal'));
                modal.show();
            });
            
            document.getElementById('savePasswordBtn').addEventListener('click', changePassword);
            
            // Filtro de pesquisa em tempo real
            document.getElementById('searchInput').addEventListener('input', debounce(applyFilters, 300));
        }

        // Utilitários
        function getToken() {
            return localStorage.getItem('supabase.auth.token') || '';
        }

        function formatCPF(cpf) {
            if (!cpf) return '';
            return cpf.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function logout() {
            authManager.logout();
        }

        // Inicializar lista de candidaturas
        filteredCandidaturas = [...candidaturas];
    </script>
</body>
</html>